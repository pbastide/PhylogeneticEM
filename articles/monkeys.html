<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Analysis of the New World Monkeys dataset • PhylogeneticEM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Analysis of the New World Monkeys dataset">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">PhylogeneticEM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.8.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/tutorial.html">Tutorial</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/monkeys.html">New World Monkeys</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/pbastide/PhylogeneticEM/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Analysis of the New World Monkeys dataset</h1>
                        <h4 data-toc-skip class="author">Paul
Bastide</h4>
            
            <h4 data-toc-skip class="date">2025-09-24</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/pbastide/PhylogeneticEM/blob/master/vignettes/monkeys.Rmd" class="external-link"><code>vignettes/monkeys.Rmd</code></a></small>
      <div class="d-none name"><code>monkeys.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="dataset">Dataset<a class="anchor" aria-label="anchor" href="#dataset"></a>
</h2>
<p>The dataset is taken from Aristide et al. (2016)<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Aristide, L., dos Reis, S. F., Machado, A. C., Lima, I.,
Lopes, R. T., &amp;amp; Perez, S. I. (2016). Brain shape convergence in the
adaptive radiation of New World monkeys. Proceedings of the National
Academy of Sciences, 113(8), 2158–2163.&lt;/p&gt;"><sup>1</sup></a>, and is embedded in
the package. We can load and plot it easily.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/pbastide/PhylogeneticEM" class="external-link">PhylogeneticEM</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">monkeys</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/params_BM.html">params_BM</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>     data <span class="op">=</span> <span class="va">monkeys</span><span class="op">$</span><span class="va">dat</span>, phylo <span class="op">=</span> <span class="va">monkeys</span><span class="op">$</span><span class="va">phy</span>,</span>
<span>     show.tip.label <span class="op">=</span> <span class="cn">TRUE</span>, cex <span class="op">=</span> <span class="fl">0.5</span>, no.margin <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="monkeys_files/figure-html/data-1.png" width="672"></p>
<p>This <code>plot</code> function inherits from most of the optional
arguments of the popular <code>ape</code> plot function (here for
instance, the optional argument <code>show.tip.label</code> is used).
Many other graphical parameters can be set by the user, so as to control
the output of the function, see the manual pages for more details. The
two traits (PCs) are represented on the right, each with its own scale.
Plotting the data on the tree before analyzing it allows us to spot
potential errors or outliers.</p>
</div>
<div class="section level2">
<h2 id="inference">Inference<a class="anchor" aria-label="anchor" href="#inference"></a>
</h2>
<p>By default, the inference is done on an automatically computed grid
of 10 alpha values. To keep the computations down, we ask for a custom
grid of only 4 values, but this number should be raised on a real
application. The maximum number of shifts considered is here 10, and
should be adapted considering the size of the tree.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PhyloEM.html">PhyloEM</a></span><span class="op">(</span>phylo <span class="op">=</span> <span class="va">monkeys</span><span class="op">$</span><span class="va">phy</span>,</span>
<span>               Y_data <span class="op">=</span> <span class="va">monkeys</span><span class="op">$</span><span class="va">dat</span>,</span>
<span>               process <span class="op">=</span> <span class="st">"scOU"</span>,                   <span class="co">## scalar OU model</span></span>
<span>               random.root <span class="op">=</span> <span class="cn">TRUE</span>,                 <span class="co">## Root is stationary</span></span>
<span>               stationary.root <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>               nbr_alpha <span class="op">=</span> <span class="fl">4</span>,                      <span class="co">## Number of alpha values tested (should be raised)</span></span>
<span>               K_max <span class="op">=</span> <span class="fl">10</span>,                         <span class="co">## Maximal number of shifts</span></span>
<span>               parallel_alpha <span class="op">=</span> <span class="cn">TRUE</span>,              <span class="co">## This can be set to TRUE for</span></span>
<span>               Ncores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>                         <span class="co">## parallel computations</span></span>
<span><span class="va">res</span></span></code></pre></div>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<pre><code><span><span class="co">## Result of the PhyloEM algorithm.</span></span>
<span><span class="co">## Selected parameters by the default method:</span></span>
<span><span class="co">## 2 dimensional scOU process with a random stationary root.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Root expectations:</span></span>
<span><span class="co">##         PC1         PC2 </span></span>
<span><span class="co">##  0.01552091 -0.01483439 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Root variance:</span></span>
<span><span class="co">##               PC1           PC2</span></span>
<span><span class="co">## PC1  3.630764e-04 -9.029145e-05</span></span>
<span><span class="co">## PC2 -9.029145e-05  1.228925e-04</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Process variance:</span></span>
<span><span class="co">##               PC1           PC2</span></span>
<span><span class="co">## PC1  1.475308e-04 -3.668861e-05</span></span>
<span><span class="co">## PC2 -3.668861e-05  4.993556e-05</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Process selection strength:</span></span>
<span><span class="co">##           PC1       PC2</span></span>
<span><span class="co">## PC1 0.2031677 0.0000000</span></span>
<span><span class="co">## PC2 0.0000000 0.2031677</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Process root optimal values:</span></span>
<span><span class="co">##         PC1         PC2 </span></span>
<span><span class="co">##  0.01552091 -0.01483439 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Shifts positions on branches: 4, 63, 46 </span></span>
<span><span class="co">## Shifts values:</span></span>
<span><span class="co">##               4           63         46</span></span>
<span><span class="co">## PC1 -0.01812684 -0.093914264 0.08031859</span></span>
<span><span class="co">## PC2  0.05234025 -0.008148889 0.02527294</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## See help to see all plotting and handling functions.</span></span></code></pre>
<p>The result is stored in an object of class <code>PhyloEM</code>,
which has several extractors available (see manual). The plot function
shows solution selected by the default model selection method, but
another one can be selected if needed. The same optional parameters can
be used as before to control how the figure should look like.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<p><img src="monkeys_files/figure-html/unnamed-chunk-1-1.png" width="672"></p>
<p>Function <code>plot_criterion</code> shows the value of the default
model selection criterion for each number of shifts.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_criterion.html">plot_criterion</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span></code></pre></div>
<p><img src="monkeys_files/figure-html/unnamed-chunk-2-1.png" width="384"></p>
<p>Here, the solution selected has three shifts. As shown above, the
criterion is however a bit flat around its minimum, with a strange value
for four shifts. This outlier is actually only due to the small grid on
alpha taken in this toy example, and goes away for a finer analysis. To
try and refine this result, one solution is to use a finer grid of alpha
values. When a grid with 100 values is used, the solution with K=5
shifts is actually selected. We can plot it here for comparison.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">res</span>, params <span class="op">=</span> <span class="fu"><a href="../reference/params_process.html">params_process</a></span><span class="op">(</span><span class="va">res</span>, K <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="monkeys_files/figure-html/unnamed-chunk-3-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="equivalent-solutions">Equivalent Solutions<a class="anchor" aria-label="anchor" href="#equivalent-solutions"></a>
</h2>
<p>When plotting the solution with 5 shifts, the following warning pops
up:</p>
<pre><code><span><span class="co">## Warning in params_process.PhyloEM(res, K = 5): There are several equivalent</span></span>
<span><span class="co">## solutions for this shift position.</span></span></code></pre>
<p>Indeed, the solution with 5 shifts has three equivalent shift
allocations on the branches. These solutions can be found and plotted
thanks to the function <code>equivalent_shifts</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/equivalent_shifts.html">equivalent_shifts</a></span><span class="op">(</span><span class="va">monkeys</span><span class="op">$</span><span class="va">phy</span>, <span class="fu"><a href="../reference/params_process.html">params_process</a></span><span class="op">(</span><span class="va">res</span>, K <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     show_shifts_values <span class="op">=</span> <span class="cn">FALSE</span>, shifts_cex <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="monkeys_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
<p>Here, the three solutions are very similar, and just have to do with
the two shifts appearing on two sister branches at the bottom of the
tree. Note that all these solutions have 5 shifts, and define the same
clustering of the tips in 6 groups. These configurations all have the
same likelihood, and hence cannot be distinguished from the data.</p>
</div>
<div class="section level2">
<h2 id="invariance-by-rotation">Invariance by Rotation<a class="anchor" aria-label="anchor" href="#invariance-by-rotation"></a>
</h2>
<p>In theory, the method should not be affected by a rotation of the
dataset (see Adams &amp; Collyer, 2018 <a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Adams, D. C., &amp;amp; Collyer, M. L. (2018). Multivariate
Phylogenetic Comparative Methods: Evaluations, Comparisons, and
Recommendations. Systematic Biology, 67(1), 14–31.&lt;/p&gt;"><sup>2</sup></a> for a review of this
problem). However, because of some numerical issues, it is possible that
the results vary a little bit. We can explore this behavior on this
dataset.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># An arbitrary rotation</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="va">pi</span><span class="op">/</span><span class="fl">4</span></span>
<span><span class="va">rot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rotate data</span></span>
<span><span class="va">Yrot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">rot</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">monkeys</span><span class="op">$</span><span class="va">dat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">Yrot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">monkeys</span><span class="op">$</span><span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># PhyloEM on rotated data</span></span>
<span><span class="va">res_rot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PhyloEM.html">PhyloEM</a></span><span class="op">(</span>phylo <span class="op">=</span> <span class="va">monkeys</span><span class="op">$</span><span class="va">phy</span>,</span>
<span>                   Y_data <span class="op">=</span> <span class="va">Yrot</span>,                      <span class="co">## rotated data</span></span>
<span>                   process <span class="op">=</span> <span class="st">"scOU"</span>,                   </span>
<span>                   random.root <span class="op">=</span> <span class="cn">TRUE</span>,                 </span>
<span>                   stationary.root <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   nbr_alpha <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                   K_max <span class="op">=</span> <span class="fl">10</span>,                         </span>
<span>                   parallel_alpha <span class="op">=</span> <span class="cn">TRUE</span>,              </span>
<span>                   Ncores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>                         </span></code></pre></div>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">res_rot</span><span class="op">)</span></span></code></pre></div>
<p><img src="monkeys_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
<p>At first sight, the solution looks very different. Indeed, when
applied on the rotated dataset, <code>PhyloEM</code> selects for a
solution with 7 shifts, instead of 3. But, if we look at the solution
obtained for, say, 3 shifts, then they are identical:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">res</span>, params <span class="op">=</span> <span class="fu"><a href="../reference/params_process.html">params_process</a></span><span class="op">(</span><span class="va">res</span>, K <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, no.margin <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">res_rot</span>, params <span class="op">=</span> <span class="fu"><a href="../reference/params_process.html">params_process</a></span><span class="op">(</span><span class="va">res</span>, K <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, no.margin <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="monkeys_files/figure-html/unnamed-chunk-7-1.png" width="288"><img src="monkeys_files/figure-html/unnamed-chunk-7-2.png" width="288"></p>
<p>Looking a bit more closely at the outcome, we can see that the log
likelihoods are actually very similar, except in a few places:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_criterion.html">plot_criterion</a></span><span class="op">(</span><span class="va">res</span>, <span class="st">"log_likelihood"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_criterion.html">plot_criterion</a></span><span class="op">(</span><span class="va">res_rot</span>, <span class="st">"log_likelihood"</span>, pch <span class="op">=</span> <span class="st">"+"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="monkeys_files/figure-html/unnamed-chunk-8-1.png" width="384"></p>
<p>What happens is that, for numerical reasons, the likelihood was
slightly better optimized in some cases for one or the other datasets.
This had an impact on the criterion used, that is based on the penalized
likelihood. We can see it with a plot:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_criterion.html">plot_criterion</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_criterion.html">plot_criterion</a></span><span class="op">(</span><span class="va">res_rot</span>, pch <span class="op">=</span> <span class="st">"+"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="monkeys_files/figure-html/unnamed-chunk-9-1.png" width="384"></p>
<p>But, as the two datasets should be equivalent, we don’t need to
choose between the two runs. For each number of shifts, our only goal is
to find the maximum likelihood solution. Hence, for each number of
shifts, we can just take the best of the two solutions, that is the one
that converged the best. This can be done with a dedicated function:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_merge</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_rotations.html">merge_rotations</a></span><span class="op">(</span><span class="va">res</span>, <span class="va">res_rot</span><span class="op">)</span></span></code></pre></div>
<p>This function takes the first fit as a reference (here, with the
original data). For a given number of shifts, when the second fit has a
better likelihood, its solution is selected instead. Note that the
parameters of the second fit are expressed in the rotated space, so,
when selected, they need to be transformed back into the original space
(which is done automatically by the function). The resulting solution
has the highest likelihood possible for each value of K, and the model
selection criterion can be applied to this new solution path.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_criterion.html">plot_criterion</a></span><span class="op">(</span><span class="va">res_merge</span><span class="op">)</span></span></code></pre></div>
<p><img src="monkeys_files/figure-html/unnamed-chunk-10-1.png" width="384"></p>
<p>We can see here that the solution with 3 shifts is now selected
again.</p>
<p>This merge function can be applied to more that two fits, as
illustrated below.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># An other rotation</span></span>
<span><span class="va">theta</span> <span class="op">&lt;-</span> <span class="va">pi</span><span class="op">/</span><span class="fl">3</span></span>
<span><span class="va">rot2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">cos</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rotate data</span></span>
<span><span class="va">Yrot2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">rot2</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">monkeys</span><span class="op">$</span><span class="va">dat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">Yrot2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">monkeys</span><span class="op">$</span><span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># PhyloEM on rotated data</span></span>
<span><span class="va">res_rot2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PhyloEM.html">PhyloEM</a></span><span class="op">(</span>phylo <span class="op">=</span> <span class="va">monkeys</span><span class="op">$</span><span class="va">phy</span>,</span>
<span>                   Y_data <span class="op">=</span> <span class="va">Yrot2</span>,</span>
<span>                   process <span class="op">=</span> <span class="st">"scOU"</span>,                   </span>
<span>                   random.root <span class="op">=</span> <span class="cn">TRUE</span>,                 </span>
<span>                   stationary.root <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   nbr_alpha <span class="op">=</span> <span class="fl">2</span>,           <span class="co">## Note that this can also be different</span></span>
<span>                   K_max <span class="op">=</span> <span class="fl">10</span>,                        </span>
<span>                   parallel_alpha <span class="op">=</span> <span class="cn">TRUE</span>,            </span>
<span>                   Ncores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>                        </span>
<span></span>
<span><span class="co"># Merge</span></span>
<span><span class="va">res_merge2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_rotations.html">merge_rotations</a></span><span class="op">(</span><span class="va">res</span>, <span class="va">res_rot</span>, <span class="va">res_rot2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<p>Here, this does not change the result.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_criterion.html">plot_criterion</a></span><span class="op">(</span><span class="va">res_merge2</span><span class="op">)</span></span></code></pre></div>
<p><img src="monkeys_files/figure-html/unnamed-chunk-11-1.png" width="384"></p>
</div>
<div class="section level2">
<h2 id="lizard-dataset">Lizard Dataset<a class="anchor" aria-label="anchor" href="#lizard-dataset"></a>
</h2>
<p>On the previous dataset, the introduction of rotations might appear a
bit artificial. However, for some highly correlated datasets, such
rotations might be needed. For instance, when studying the Anolis Lizard
dataset (Mahler et al., 2013<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Mahler, D. L., Ingram, T., Revell, L. J., &amp;amp; Losos,
J. B. (2013). Exceptional Convergence on the Macroevolutionary Landscape
in Island Lizard Radiations. Science, 341(6143), 292–295.&lt;/p&gt;"><sup>3</sup></a>), the application of several
pseudo-orthonormalization techniques on the original dataset were needed
to get a good maximum likelihood solution for all values of K. See
Bastide et al. (2018)<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Bastide, P., Ané, C., Robin, S., &amp;amp; Mariadassou, M.
(2018). Inference of Adaptive Shifts for Multivariate Correlated Traits.
Systematic Biology, 67(4), 662–680.&lt;/p&gt;"><sup>4</sup></a> for more details on this analysis.</p>
</div>
<div class="section level2">
<h2 id="eb-model">EB model<a class="anchor" aria-label="anchor" href="#eb-model"></a>
</h2>
<p>It can be shown that an Early Burst model (EB) is formally equivalent
on an ultrametric tree to a non-shifted scOU with a negative alpha
value. It is possible to include this model in the fit, by allowing
“negative alpha” values in the function <code>PhyloEM</code>.</p>
<p>Note that, although the case with no shift has a clear interpretation
(EB model), an scOU with shifts and a negative alpha can be hard to
interpret, and is not always appropriate. One should hence be careful
when using and interpreting such a model, and the use of this
functionality is not encouraged for a first analysis.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_neg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PhyloEM.html">PhyloEM</a></span><span class="op">(</span>phylo <span class="op">=</span> <span class="va">monkeys</span><span class="op">$</span><span class="va">phy</span>,</span>
<span>                   Y_data <span class="op">=</span> <span class="va">monkeys</span><span class="op">$</span><span class="va">dat</span>,</span>
<span>                   process <span class="op">=</span> <span class="st">"scOU"</span>,</span>
<span>                   random.root <span class="op">=</span> <span class="cn">FALSE</span>,      <span class="co">## root needs to be fixed</span></span>
<span>                   K_max <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                   parallel_alpha <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                   Ncores <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                   nbr_alpha <span class="op">=</span> <span class="fl">4</span>,            <span class="co">## 2 negative, 2 positive (should be more)</span></span>
<span>                   allow_negative <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>    <span class="co">## allow negative alpha in the grid</span></span></code></pre></div>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |======                                                                |   9%  |                                                                              |=============                                                         |  18%  |                                                                              |===================                                                   |  27%  |                                                                              |=========================                                             |  36%  |                                                                              |================================                                      |  45%  |                                                                              |======================================                                |  55%  |                                                                              |=============================================                         |  64%  |                                                                              |===================================================                   |  73%  |                                                                              |=========================================================             |  82%  |                                                                              |================================================================      |  91%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<p>We can extract the parameter of the fit with no shift, that is
equivalent to an EB model:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/params_process.html">params_process</a></span><span class="op">(</span><span class="va">res_neg</span>, K <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in params_process.PhyloEM(res_neg, K = 0): The 'selection strength' is</span></span>
<span><span class="co">## negative. One should only look at the un-normalized values of the shifts. To do</span></span>
<span><span class="co">## so, please call this function using 'rBM = TRUE'.</span></span></code></pre>
<pre><code><span><span class="co">## Warning in check.selection.strength(process, ...): All the eigen values of the</span></span>
<span><span class="co">## selection strengh do not have a strictly positive real part. That might cause</span></span>
<span><span class="co">## some issue. Proceed with caution.</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## 2 dimensional scOU process with a fixed root.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Root value:</span></span>
<span><span class="co">##          PC1          PC2 </span></span>
<span><span class="co">##  0.006507194 -0.003532184 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Process variance:</span></span>
<span><span class="co">##               PC1           PC2</span></span>
<span><span class="co">## PC1  5.367696e-05 -5.648422e-06</span></span>
<span><span class="co">## PC2 -5.648422e-06  1.273209e-05</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Process selection strength:</span></span>
<span><span class="co">##             PC1         PC2</span></span>
<span><span class="co">## PC1 -0.01316466  0.00000000</span></span>
<span><span class="co">## PC2  0.00000000 -0.01316466</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Process root optimal values:</span></span>
<span><span class="co">##          PC1          PC2 </span></span>
<span><span class="co">##  0.006507194 -0.003532184 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## This process has no shift.</span></span></code></pre>
<p>The “selection strength”
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
is linked with the rate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>
of the EB by the relation:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>=</mo><mn>2</mn><mi>α</mi></mrow><annotation encoding="application/x-tex">r = 2\alpha</annotation></semantics></math>.</p>
<p>We can also plot the criterion for the model selection. Empirically,
we found that the “BGHmlraw” criterion would behave a bit better in this
configuration.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_criterion.html">plot_criterion</a></span><span class="op">(</span><span class="va">res_neg</span>, <span class="st">"BGHmlraw"</span><span class="op">)</span></span></code></pre></div>
<p><img src="monkeys_files/figure-html/unnamed-chunk-13-1.png" width="384"></p>
<p>Here, a same solution with 7 shifts (and a positive alpha) is
selected. Again, to keep computations to a minimum, we used a very
coarse grid with only 4 values of alpha. On a finer grid, the same
solution with 5 shifts is selected.</p>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Paul Bastide.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
